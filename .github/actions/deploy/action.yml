name: "deploy"
description: "deploy action"
inputs:
  CF_DIST_ID:
    required: true
  S3_BUCKET:
    required: true  
  CLIENT_ID:
    required: true 

runs:
  using: "composite"
  steps:
    - name: Checkout current commit
      uses: actions/checkout@v4

    - uses: actions/download-artifact@v4
      with:
        name: "fstandard-artifact"
        path: dist

    - name: Setup Python 3.7 for awscli
      uses: actions/setup-python@v4
      with:
        version: "3.7"
        architecture: "x64"     

    - name: Install awscli
      shell: bash
      run: pip install --upgrade pip awscli

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ env.AWS_IAM_ROLE }}
        aws-region: ap-northeast-1

    - name: Retrieve secret from AWS Secrets Manager
      id: get_secret
      shell: bash
      run: |
        SECRET=$(aws secretsmanager get-secret-value --secret-id multiTenantEnv --query SecretString --output text)
        echo "SECRET=$SECRET" >> $GITHUB_ENV

    - id: extract_variable
      run: |
        CF_DIST_ID_KEY=${{ format('{0}_CF_DIST_ID', inputs.CLIENT_ID) }}
        echo "CF_DIST_ID_KEY=$CF_DIST_ID_KEY" >> "$GITHUB_OUTPUT"
        S3_BUCKET_KEY=${{ format('{0}_S3_BUCKET', inputs.CLIENT_ID) }}
        echo "S3_BUCKET_KEY=$S3_BUCKET_KEY" >> "$GITHUB_OUTPUT"

    - name: Log secrets
      shell: bash
      run: | 
        echo "Using secrets: $SECRET"               
        echo "Using S3_BUCKET_KEY: $S3_BUCKET_KEY"     
        echo "Using S3_BUCKET_KEY: $CF_DIST_ID_KEY"     

        echo "CF_DIST_ID: $(echo $SECRET | jq -r --arg key "$CF_DIST_ID_KEY")"
        echo "S3_BUCKET: $(echo $SECRET | jq -r --arg key "$S3_BUCKET_KEY")"

        echo "CF_DIST_ID=$CF_DIST_ID" >> "$GITHUB_OUTPUT"
        echo "S3_BUCKET=$S3_BUCKET" >> "$GITHUB_OUTPUT"
        echo "Using client: ${{inputs.CLIENT_ID}}"     

    - name: Log env
      shell: bash   
      run: |
        echo "S3 env is $S3_BUCKET"          
        echo "CF env is $CF_DIST_ID"          

    - name: Deploy static site to S3 bucket
      shell: bash
      run: |
        aws s3 sync --delete dist ${{inputs.S3_BUCKET}} --cache-control max-age=60,s-maxage=60

    - name: Delete cf cache
      shell: bash
      run: |
        aws cloudfront create-invalidation --distribution-id ${{inputs.CF_DIST_ID}} --paths "/*"



